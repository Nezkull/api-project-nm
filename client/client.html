<!DOCTYPE html>
<html lang="en">
<head>
  <title>Our simple HTTP server</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');
      
        // this needs change to thingys
      switch(xhr.status) {
        case 200:
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201:
          content.innerHTML = '<b>Create</b>';
          break;
        case 204:
          content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 400:
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404:
          content.innerHTML = `<b>Resource Not Found</b>`;
          break;
        default:
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }

        
     if(parseResponse){
        const obj = JSON.parse(xhr.response);
        console.log("in parseResponse");
         console.dir(obj);
         
         // idk if I need this keep for now
        if(obj.message) {
            const p = document.createElement('p');
            p.textContent = `Message: ${obj.message}`;
            content.appendChild(p);
        }
      
         // change from users to responses
        if(obj.users) {
            const userList = document.createElement('p');
            const users = JSON.stringify(obj.users);
            userList.textContent = users;
            content.appendChild(userList);
        }
         
         if(obj.posts){
             const postList = document.createElement('p');
             const post = JSON.stringify(obj.posts);
             postList.textContent = post;
             content.appendChild(postList);
             
             // console.dir("resp1: " + obj.posts[0].resp1);
             console.dir("resp1: " + post.resp1);
         }
        
     }else{
         // nothing happens here
     }
    };

    // update this to have multiple text fields
    const sendPost = (e, nameForm) => {
      e.preventDefault();
        
        // these might be needed
      const nameAction = nameForm.getAttribute('action');
      const nameMethod = nameForm.getAttribute('method');
      
      const nameField = nameForm.querySelector('#nameField'); // need this
      const ageField = nameForm.querySelector('#ageField'); // dont need this here
      
      const xhr = new XMLHttpRequest();
        
      xhr.open(nameMethod, nameAction);
      
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      
      xhr.onload = () => handleResponse(xhr, true);
      
      const formData = `name=${nameField.value}&age=${ageField.value}`;
      
      xhr.send(formData);
    
      return false;
    }

    const postSubmission = (e, nameForm) => {
        e.preventDefault();
        
        const nameAction = nameForm.getAttribute('action');
        const nameMethod = nameForm.getAttribute('method');
        
        // get the name
        const nameField = nameForm.querySelector('#nameField');
        
        console.dir(nameField); // gives correct readout
        
        // get an array of all of the text responses
        const respFields = nameForm.getElementsByClassName('statementField');
        
        console.dir(respFields); // gives correct readouts
        console.dir(respFields[2]); // gives correct readout
        // get the lie input selector
        const lieSelector = nameForm.querySelector('#lie');
    
        console.dir(lieSelector); // gives correct readout
        
        const xhr = new XMLHttpRequest();
        
        // nameMethod needs to be changed in the html tag to be addPost instead of addUser
        xhr.open(nameMethod, nameAction);
        
        xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        xhr.setRequestHeader ('Accept', 'application/json');
        
        // handleResponse needs to be changed to accept any different parameters that I might need, maybe not though who knows
        xhr.onload = () => handleResponse(xhr, true);
        
        const formData = `name=${nameField.value}&resp1=${respFields[0].value}&resp2=${respFields[1].value}&resp3=${respFields[2].value}&resp4=${respFields[3].value}&lie=${lieSelector.value}`;
        xhr.send(formData);
    };
    
    // this needs much changing
    const requestUpdate = (e, userForm) => {
        e.preventDefault();
        
        const url = userForm.querySelector('#urlField').value;
        
        const method = userForm.querySelector('#methodSelect').value;
        
        const xhr = new XMLHttpRequest();
        
        xhr.open(method, url);
        
        xhr.setRequestHeader('Accept', 'application/json');
        
        if(method == 'get'){
            xhr.onload = () => handleResponse(xhr, true);
        }else{
            xhr.onload = () => handleResponse(xhr, false);
        }
        
        xhr.send();
        
        return false;
    };

    const requestPosts = (e, userForm) => {
      e.preventDefault();
        
        const url = userForm.querySelector('#urlField').value;
        const method = userForm.querySelector('#methodSelect').value;
        const xhr = new XMLHttpRequest();
        
        xhr.open(method, url);
        
        xhr.setRequestHeader('Accept', 'application/json');
        
        xhr.onload = () => handleResponse(xhr, true);
        
        xhr.send();
        
        return false;
    };

    const updateImage = (e, select) => {
        e.preventDefault();
        
        // add consts here to get image select value then update source
        // const select = document.querySelector('#imageSelect');
        const img = document.querySelector('#previewImage');
        
        img.src = select.options[select.selectedIndex].value;
        
        return false;
    };

    const init = () => {
        const userForm = document.querySelector('#userForm');
        const nameForm = document.querySelector('#nameForm');
        
        const getUsers = (e) => requestPosts(e, userForm);
        // const addUsers = (e) => sendPost(e, nameForm);
        const addPost = (e) => postSubmission(e, nameForm);
        
        userForm.addEventListener('submit', getUsers);
        // nameForm.addEventListener('submit', addUsers);
        nameForm.addEventListener('submit', addPost);
        
        const imageSelect = document.querySelector('#imageSelect');
        
        const changeImage = (e) => updateImage(e, imageSelect);
        imageSelect.addEventListener('change', changeImage);
    };

    window.onload = init;

  </script>
</head>
<body>
  <section id="top">
      <!--   change the h3 tag text, maybe have it change based on if the user is uploading stuff or playing the game?   -->
    <h3>POST Status Code Tests</h3>
      
      
      
<!--   This needs to be changed a bit, action needs to be changed to something else   -->
    <form id="nameForm" action="/addPost" method="post">
      <label for="name">Name: </label>
      <input id="nameField" type="text" name="name" /><br>
<!--
      <label for="age">Age: </label>
      <input id="ageField" type="number" name="age" min="0" max="100" step="1"/>
-->
        <img id="previewImage" src="../media/bread.png"><br>
        <label for="imageSelect">Image: </label>
        <select id="imageSelect" name="imageSelect">
            <option value="../media/bread.png">Bread</option>
            <option value="../media/lamp.png">Lamp</option>
        </select><br>
        
        <!--    These input elements are the entry fields for the statements.    -->
        <label for="response1">Statement 1: </label>
        <input class="statementField" id="resp1" type="text" name="response1" /><br>
        
        <label for="response2">Statement 2: </label>
        <input class="statementField" id="resp2" type="text" name="response2" /><br>
        
        <label for="response3">Statement 3: </label>
        <input class="statementField" id="resp3" type="text" name="response3" /><br>
        
        <label for="response4">Statement 4: </label>
        <input class="statementField" id="resp4" type="text" name="response4" /><br>
        
        <!--     class="statementField"    -->
        
        <!--    This input element is used to decide which response is the lie.    -->
        <label for="lie">Lie: </label>
        <input id="lie" type="number" name="lie" min="1" max="4" step="1" /><br>
        
      <input type="submit" value="Post Submission" />
    </form>
      
      <!--   This needs to be changed to so that when option is changed posts are pulled from the server.   -->
    <form id="userForm" action="/getUsers" method="get">
      <select id='urlField'>
<!--     these need to be changed, actually I don't think these are needed at all     -->
        <option value='/getUsers'>/getUsers</option>
        <option value='/notReal'>/notReal</option>
          <option value='/getPosts'>/getPosts</option>
      </select>
<!--    these need to be modified    -->
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Get Posts" />
    </form>
  </section>
  <section id="content">
  </section>
</body>
</html>
